# ë°ì´í„° ì„¤ê³„ ë¬¸ì„œ

**ì‘ì„±ì¼**: 2024-12-30
**ì‘ì„±ì**: Development Team
**ë²„ì „**: 1.0

---

## ğŸ“Œ ìš”ì•½

ClosetConnectì˜ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ, ERD, ì¸ë±ìŠ¤ ì „ëµ, ë°ì´í„° ì¦ê°€ ëŒ€ì‘ ë°©ì•ˆì„ ì •ë¦¬í•©ë‹ˆë‹¤.

---

## 1. ERD (Entity Relationship Diagram)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Users    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1
       â”‚
       â”‚ N
â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Cloth    â”‚       â”‚     Ootd     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                      â”‚
       â”‚ 1                    â”‚ N
       â”‚                      â”‚
       â”‚ N                    â”‚ 1
â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
â”‚            Users                    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1               â”‚ 1
       â”‚                 â”‚
       â”‚ N               â”‚ N
â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Post     â”‚   â”‚  MarketProduct  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1                  â”‚ 1
       â”‚                    â”‚
       â”‚ N                  â”‚ N
â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Comment   â”‚       â”‚ MarketOrder  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ì£¼ìš” í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ

### 2.1 users (ì‚¬ìš©ì)

```sql
CREATE TABLE users (
    user_id BIGINT AUTO_INCREMENT PRIMARY KEY,
    email VARCHAR(100) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,  -- BCrypt í•´ì‹œ
    nickname VARCHAR(50) NOT NULL UNIQUE,
    role VARCHAR(20) NOT NULL,  -- ROLE_USER, ROLE_ADMIN
    status VARCHAR(20) NOT NULL DEFAULT 'NORMAL',  -- NORMAL, SUSPENDED, DELETED
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    INDEX idx_email (email),
    INDEX idx_nickname (nickname)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**ì»¬ëŸ¼ ì„¤ëª…**:
- `user_id`: ì‚¬ìš©ì ê³ ìœ  ID (PK)
- `email`: ë¡œê·¸ì¸ ID (UNIQUE)
- `password`: BCrypt ì•”í˜¸í™” ë¹„ë°€ë²ˆí˜¸
- `nickname`: ë‹‰ë„¤ì„ (UNIQUE)
- `role`: ê¶Œí•œ (ENUM)
- `status`: ê³„ì • ìƒíƒœ
- `created_at`, `updated_at`: ê°ì‚¬ í•„ë“œ

---

### 2.2 cloth (ì˜·)

```sql
CREATE TABLE cloth (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    name VARCHAR(100) NOT NULL,
    category VARCHAR(20) NOT NULL,  -- TOP, BOTTOM, SHOES, ACC
    image_url VARCHAR(500) NOT NULL,
    segmented_image_url VARCHAR(500),
    inpainted_image_url VARCHAR(500),
    status VARCHAR(30) NOT NULL,  -- PROCESSING, READY_FOR_REVIEW, CONFIRMED
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_category (category),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**ì¸ë±ìŠ¤ ì „ëµ**:
- `idx_user_id`: ì‚¬ìš©ìë³„ ì˜· ì¡°íšŒ (ê°€ì¥ ë¹ˆë²ˆ)
- `idx_category`: ì¹´í…Œê³ ë¦¬ë³„ í•„í„°ë§
- `idx_status`: AI ì²˜ë¦¬ ìƒíƒœ ì¡°íšŒ

---

### 2.3 ootd

```sql
CREATE TABLE ootd (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    image_url VARCHAR(500) NOT NULL,
    description VARCHAR(100),
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    INDEX idx_user_created (user_id, created_at DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**ì¸ë±ìŠ¤ ì „ëµ**:
- `idx_user_created`: ì‚¬ìš©ìë³„ ìµœì‹  ìˆœ ì¡°íšŒ (ë³µí•© ì¸ë±ìŠ¤)

---

### 2.4 community_board (ê²Œì‹œíŒ)

```sql
CREATE TABLE community_board (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    slug VARCHAR(50) NOT NULL UNIQUE,
    visibility VARCHAR(20) NOT NULL,  -- PUBLIC, PRIVATE, ADMIN_ONLY
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    INDEX idx_slug (slug)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

### 2.5 post (ê²Œì‹œê¸€)

```sql
CREATE TABLE post (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    board_id BIGINT NOT NULL,
    author_id BIGINT NOT NULL,
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    view_count INT NOT NULL DEFAULT 0,
    pinned BOOLEAN NOT NULL DEFAULT FALSE,
    status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',  -- ACTIVE, DELETED, REPORTED
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    FOREIGN KEY (board_id) REFERENCES community_board(id) ON DELETE CASCADE,
    FOREIGN KEY (author_id) REFERENCES users(user_id) ON DELETE CASCADE,
    INDEX idx_board_created (board_id, created_at DESC),
    INDEX idx_author (author_id),
    INDEX idx_pinned (pinned, created_at DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**ì¸ë±ìŠ¤ ì „ëµ**:
- `idx_board_created`: ê²Œì‹œíŒë³„ ìµœì‹  ìˆœ (ë³µí•© ì¸ë±ìŠ¤)
- `idx_pinned`: ê³ ì • ê²Œì‹œê¸€ ìš°ì„  ì •ë ¬

---

### 2.6 comment (ëŒ“ê¸€)

```sql
CREATE TABLE comment (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    post_id BIGINT NOT NULL,
    author_id BIGINT NOT NULL,
    content TEXT NOT NULL,
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    FOREIGN KEY (post_id) REFERENCES post(id) ON DELETE CASCADE,
    FOREIGN KEY (author_id) REFERENCES users(user_id) ON DELETE CASCADE,
    INDEX idx_post_created (post_id, created_at ASC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

### 2.7 market_product (ì¤‘ê³ ê±°ë˜ ìƒí’ˆ)

```sql
CREATE TABLE market_product (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    seller_id BIGINT NOT NULL,
    title VARCHAR(200) NOT NULL,
    description TEXT NOT NULL,
    price DECIMAL(10, 2) NOT NULL,
    status VARCHAR(20) NOT NULL,  -- SALE, RESERVED, SOLD_OUT
    category VARCHAR(20),
    size VARCHAR(10),
    condition_type VARCHAR(20),
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    FOREIGN KEY (seller_id) REFERENCES users(user_id) ON DELETE CASCADE,
    INDEX idx_status_created (status, created_at DESC),
    INDEX idx_seller (seller_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

### 2.8 market_order (ì£¼ë¬¸)

```sql
CREATE TABLE market_order (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    product_id BIGINT NOT NULL,
    buyer_id BIGINT NOT NULL,
    amount DECIMAL(10, 2) NOT NULL,
    status VARCHAR(20) NOT NULL,  -- PENDING, PAID, SHIPPED, DELIVERED, CANCELLED
    payment_key VARCHAR(255),
    tracking_number VARCHAR(100),
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    FOREIGN KEY (product_id) REFERENCES market_product(id),
    FOREIGN KEY (buyer_id) REFERENCES users(user_id),
    INDEX idx_buyer_created (buyer_id, created_at DESC),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

## 3. ì •ê·œí™”/ë¹„ì •ê·œí™” ì´ìœ 

### ì •ê·œí™” (3NF)
- **users, cloth, ootd**: ì¤‘ë³µ ë°ì´í„° ìµœì†Œí™”
- **post, comment**: ê²Œì‹œê¸€-ëŒ“ê¸€ 1:N ê´€ê³„ ëª…í™•
- **market_product, market_order**: ìƒí’ˆ-ì£¼ë¬¸ ë¶„ë¦¬

### ë¹„ì •ê·œí™” (ì„ íƒ)
- **post.view_count**: ì¡°íšŒìˆ˜ëŠ” ë³„ë„ í…Œì´ë¸”ë³´ë‹¤ ì§ì ‘ ì €ì¥ì´ íš¨ìœ¨ì 
- **image_url ì§ì ‘ ì €ì¥**: JOIN ì—†ì´ ì¡°íšŒ ê°€ëŠ¥

---

## 4. ì¸ë±ìŠ¤ ì „ëµ

### ë³µí•© ì¸ë±ìŠ¤ ì‚¬ìš© ì´ìœ 
1. **`idx_user_created` (user_id, created_at DESC)**
   - WHERE user_id = ? ORDER BY created_at DESC ì¿¼ë¦¬ ìµœì í™”
   - ë‹¨ì¼ ì¸ë±ìŠ¤ 2ê°œë³´ë‹¤ ì„±ëŠ¥ ìš°ìˆ˜

2. **`idx_board_created` (board_id, created_at DESC)**
   - ê²Œì‹œíŒë³„ ìµœì‹  ê¸€ ì¡°íšŒ

### ì¸ë±ìŠ¤ í¬ê¸° ê³ ë ¤
- VARCHAR í•„ë“œ ì¸ë±ìŠ¤ëŠ” ê¸¸ì´ ì œí•œ (email(100) â†’ email(50))
- TEXT í•„ë“œëŠ” ì¸ë±ìŠ¤ ë¶ˆê°€ (Full-Text Index ê³ ë ¤)

---

## 5. ë°ì´í„° ì¦ê°€ ì‹œ ëŒ€ì‘

### ì˜ˆìƒ ë°ì´í„° ì¦ê°€ìœ¨
| í…Œì´ë¸” | ì‚¬ìš©ì 1000ëª… ê¸°ì¤€ | ì—°ê°„ ì¦ê°€ |
|--------|-------------------|----------|
| cloth | 5,000ê±´ (5ê±´/ì‚¬ìš©ì) | 60,000ê±´ |
| ootd | 2,000ê±´ (2ê±´/ì‚¬ìš©ì) | 24,000ê±´ |
| post | 10,000ê±´ | 120,000ê±´ |
| market_product | 3,000ê±´ | 36,000ê±´ |

### ëŒ€ì‘ ë°©ì•ˆ

#### Phase 1 (í˜„ì¬, ~10ë§Œ ê±´)
- ë‹¨ì¼ í…Œì´ë¸”
- ê¸°ë³¸ ì¸ë±ìŠ¤

#### Phase 2 (10ë§Œ~100ë§Œ ê±´)
- **íŒŒí‹°ì…”ë‹**: created_at ê¸°ì¤€ ì›”ë³„ íŒŒí‹°ì…˜
  ```sql
  ALTER TABLE post PARTITION BY RANGE (YEAR(created_at) * 100 + MONTH(created_at)) (
      PARTITION p202401 VALUES LESS THAN (202402),
      PARTITION p202402 VALUES LESS THAN (202403),
      ...
  );
  ```

#### Phase 3 (100ë§Œ ê±´ ì´ìƒ)
- **Sharding**: user_id ê¸°ì¤€ DB ë¶„ì‚°
- **Archive**: 1ë…„ ì´ìƒ ë°ì´í„°ëŠ” ë³„ë„ í…Œì´ë¸”ë¡œ ì´ë™

---

## 6. Soft Delete vs Hard Delete

### Soft Delete (ì±„íƒ)
```sql
ALTER TABLE post ADD COLUMN deleted_at DATETIME;
```

**ì¥ì **:
- ì‹¤ìˆ˜ë¡œ ì‚­ì œí•œ ë°ì´í„° ë³µêµ¬ ê°€ëŠ¥
- í†µê³„/ë¶„ì„ì— í™œìš©

**ë‹¨ì **:
- ë””ìŠ¤í¬ ê³µê°„ ì¦ê°€
- ì¿¼ë¦¬ì— `WHERE deleted_at IS NULL` í•„ìˆ˜

### Hard Delete
- CASCADE ì„¤ì •ìœ¼ë¡œ ê´€ë ¨ ë°ì´í„° ìë™ ì‚­ì œ
- í˜„ì¬ëŠ” Hard Delete ì‚¬ìš© (ë‹¨ìˆœì„± ìš°ì„ )

---

## 7. ë°±ì—… ì „ëµ

### ì „ì²´ ë°±ì—…
- **ë¹ˆë„**: ë§¤ì¼ ìƒˆë²½ 3ì‹œ
- **ë³´ê´€**: 7ì¼ì¹˜

```bash
mysqldump -u app_user -p closetConnectProject > backup-$(date +%Y%m%d).sql
```

### ì¦ë¶„ ë°±ì—… (í–¥í›„)
- Binary Log í™œì„±í™”
- Point-In-Time Recovery ê°€ëŠ¥

---

## ë³€ê²½ ì´ë ¥

| ë‚ ì§œ | ë²„ì „ | ì‘ì„±ì | ë³€ê²½ ë‚´ìš© |
|------|------|--------|-----------|
| 2024-12-30 | 1.0 | Development Team | ì´ˆê¸° ë¬¸ì„œ ì‘ì„± |
