# 모니터링/로그 문서

**작성일**: 2024-12-30
**작성자**: Development Team
**버전**: 1.0

---

## 📌 요약

ClosetConnect의 모니터링 지표, 로그 위치, 알람 기준, 장애 감지 흐름을 정리합니다.

---

## 1. 수집 지표

### 1.1 시스템 지표

#### CPU
- **지표**: CPU 사용률 (%)
- **정상 범위**: 0-70%
- **경고**: 70-90%
- **위험**: 90% 이상

#### 메모리
- **지표**: 메모리 사용률 (%)
- **정상 범위**: 0-80%
- **경고**: 80-95%
- **위험**: 95% 이상

#### 디스크
- **지표**: 디스크 사용률 (%)
- **정상 범위**: 0-80%
- **경고**: 80-90%
- **위험**: 90% 이상

**수집 명령**:
```bash
# CPU
top -bn1 | grep "Cpu(s)" | awk '{print $2}'

# 메모리
free -m | awk 'NR==2{printf "%.2f%%", $3*100/$2}'

# 디스크
df -h | grep '/$' | awk '{print $5}'
```

---

### 1.2 애플리케이션 지표

#### HTTP 요청
- **지표**: 초당 요청 수 (RPS)
- **정상 범위**: 0-100 RPS
- **경고**: 100-500 RPS
- **위험**: 500+ RPS

#### 응답 시간
- **지표**: 평균 응답 시간 (ms)
- **목표**: P95 < 1000ms
- **경고**: P95 > 2000ms

#### 에러율
- **지표**: 5xx 에러 비율 (%)
- **정상**: < 0.1%
- **경고**: 0.1-1%
- **위험**: 1% 이상

**Spring Boot Actuator 사용**:
```bash
# Health Check
curl http://localhost:8080/actuator/health

# Metrics
curl http://localhost:8080/actuator/metrics/http.server.requests
```

**Actuator 설정** (`application.properties`):
```properties
management.endpoints.web.exposure.include=health,metrics,info
management.endpoint.health.show-details=always
```

---

### 1.3 비즈니스 지표

#### 옷 등록 성공률
- **지표**: (성공 / 전체) × 100%
- **목표**: > 95%

```sql
SELECT
    COUNT(*) AS total,
    SUM(CASE WHEN status = 'CONFIRMED' THEN 1 ELSE 0 END) AS success,
    (SUM(CASE WHEN status = 'CONFIRMED' THEN 1 ELSE 0 END) * 100.0 / COUNT(*)) AS success_rate
FROM cloth
WHERE created_at > NOW() - INTERVAL 1 DAY;
```

#### AI 처리 평균 시간
- **지표**: 평균 처리 시간 (초)
- **목표**: < 60초

```sql
SELECT AVG(TIMESTAMPDIFF(SECOND, created_at, updated_at)) AS avg_seconds
FROM cloth
WHERE status = 'CONFIRMED'
  AND created_at > NOW() - INTERVAL 1 DAY;
```

#### 결제 성공률
- **지표**: (PAID / PENDING) × 100%
- **목표**: > 80%

```sql
SELECT
    SUM(CASE WHEN status = 'PAID' THEN 1 ELSE 0 END) AS paid,
    COUNT(*) AS total,
    (SUM(CASE WHEN status = 'PAID' THEN 1 ELSE 0 END) * 100.0 / COUNT(*)) AS success_rate
FROM market_order
WHERE created_at > NOW() - INTERVAL 1 DAY;
```

---

## 2. 로그 위치

### 2.1 Backend (Spring Boot)

#### 로그 파일
- **위치**: `./logs/spring.log`
- **로테이션**: 매일 자정 (또는 100MB 초과 시)
- **보관**: 7일

**Logback 설정** (`logback-spring.xml`):
```xml
<appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
    <file>logs/spring.log</file>
    <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
        <fileNamePattern>logs/spring.%d{yyyy-MM-dd}.log</fileNamePattern>
        <maxHistory>7</maxHistory>
    </rollingPolicy>
    <encoder>
        <pattern>%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n</pattern>
    </encoder>
</appender>
```

#### 로그 레벨
- **Production**: INFO
- **Development**: DEBUG

**중요 로그 패턴**:
```
# 에러 로그
2024-12-30 10:00:00 [http-nio-8080-exec-1] ERROR c.t.c.Closet.Service.ClothService - 옷 등록 실패: userId=123, error=FileUploadException

# API 호출 로그
2024-12-30 10:00:01 [http-nio-8080-exec-2] INFO  c.t.c.Closet.Controller.ClothController - POST /api/v1/cloth/upload - userId=123, fileName=shirt.png
```

### 2.2 AI Server (Python)

#### 로그 파일
- **세그멘테이션**: `./outputs/segmentation_server.log`
- **인페인팅**: `./outputs/inpainting_server.log`

**Python 로깅 설정**:
```python
import logging

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s [%(levelname)s] %(message)s',
    handlers=[
        logging.FileHandler('outputs/segmentation_server.log'),
        logging.StreamHandler()
    ]
)
```

---

## 3. 알람 기준

### 3.1 시스템 알람

| 조건 | 심각도 | 알람 방법 |
|------|--------|-----------|
| CPU > 90% (5분 이상) | 🔴 Critical | 즉시 SMS + Email |
| 메모리 > 95% | 🔴 Critical | 즉시 SMS + Email |
| 디스크 > 90% | 🟠 Warning | Email |
| Backend 프로세스 다운 | 🔴 Critical | 즉시 SMS + Email |

### 3.2 애플리케이션 알람

| 조건 | 심각도 | 알람 방법 |
|------|--------|-----------|
| 5xx 에러율 > 1% (5분) | 🔴 Critical | 즉시 Email |
| 평균 응답 시간 > 3초 | 🟠 Warning | Email |
| RabbitMQ 큐 적체 > 100건 | 🟠 Warning | Email |
| AI 처리 실패율 > 10% | 🟡 Info | Email |

### 3.3 비즈니스 알람

| 조건 | 심각도 | 알람 방법 |
|------|--------|-----------|
| 옷 등록 성공률 < 80% | 🟠 Warning | Email |
| 결제 성공률 < 70% | 🔴 Critical | Email |
| 신규 가입자 0명 (24시간) | 🟡 Info | Email |

---

## 4. 장애 감지 흐름

### 4.1 Health Check

#### Backend Health Check
```bash
# 1분마다 실행 (Cron)
*/1 * * * * curl -f http://localhost:8080/actuator/health || echo "Backend Down!" | mail -s "Alert" admin@example.com
```

**Response (정상)**:
```json
{
  "status": "UP",
  "components": {
    "db": { "status": "UP" },
    "diskSpace": { "status": "UP" },
    "rabbit": { "status": "UP" }
  }
}
```

#### AI Server Health Check
```bash
curl http://localhost:8000/health
curl http://localhost:8001/health
```

### 4.2 RabbitMQ 모니터링

```bash
# 큐 상태 확인
sudo rabbitmqctl list_queues name messages consumers

# 예시 출력
# cloth.processing.queue   15   2
# cloth.progress.queue     0    1
# cloth.result.queue       0    1
```

**알람 조건**:
- `messages > 100`: 처리 지연
- `consumers = 0`: Worker 다운

---

## 5. 로그 분석 쿼리

### 에러 로그 카운트 (최근 1시간)
```bash
grep "ERROR" logs/spring.log | grep "$(date -u +%Y-%m-%d\ %H)" | wc -l
```

### 가장 많은 에러 TOP 5
```bash
grep "ERROR" logs/spring.log | awk '{print $6}' | sort | uniq -c | sort -rn | head -5
```

### API 응답 시간 분석 (사용자 정의 로그 필요)
```bash
# 로그 형식: ... - API: /api/v1/cloth - Duration: 1234ms
grep "Duration:" logs/spring.log | awk '{print $NF}' | sed 's/ms//' | awk '{sum+=$1; count++} END {print "Average:", sum/count, "ms"}'
```

---

## 6. 모니터링 도구 (향후 도입)

### Phase 2
- **Prometheus + Grafana**: 실시간 대시보드
- **ELK Stack (Elasticsearch + Logstash + Kibana)**: 로그 분석
- **Sentry**: 에러 트래킹

### Phase 3
- **APM (Application Performance Monitoring)**: New Relic, DataDog
- **Uptime Monitoring**: Pingdom, UptimeRobot

---

## 7. 대시보드 구성 (향후)

### 시스템 대시보드
- CPU, 메모리, 디스크 사용률 (그래프)
- 네트워크 I/O
- 프로세스 상태

### 애플리케이션 대시보드
- RPS, 응답 시간 (P50, P95, P99)
- 에러율 (4xx, 5xx)
- DB 커넥션 풀 상태

### 비즈니스 대시보드
- DAU, MAU
- 옷 등록 수, AI 처리 성공률
- 중고거래 거래액, 결제 성공률

---

## 변경 이력

| 날짜 | 버전 | 작성자 | 변경 내용 |
|------|------|--------|-----------|
| 2024-12-30 | 1.0 | Development Team | 초기 문서 작성 |
