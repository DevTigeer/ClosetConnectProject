# ì¥ì•  ëŒ€ì‘ ë§¤ë‰´ì–¼ (Runbook)

**ì‘ì„±ì¼**: 2024-12-30
**ì‘ì„±ì**: Development Team
**ë²„ì „**: 1.0

---

## ğŸ“Œ ìš”ì•½

ClosetConnect í”„ë¡œì íŠ¸ì˜ ì£¼ìš” ì¥ì•  ìœ í˜•, ì¦ìƒ, í™•ì¸ ì§€ì , ì¡°ì¹˜ ë°©ë²•ì„ ì •ë¦¬í•©ë‹ˆë‹¤.

---

## 1. ì¥ì•  ë¶„ë¥˜

### ìš°ì„ ìˆœìœ„
- **P0 (ê¸´ê¸‰)**: ì„œë¹„ìŠ¤ ì „ì²´ ì¤‘ë‹¨
- **P1 (ë†’ìŒ)**: í•µì‹¬ ê¸°ëŠ¥ ë¶ˆê°€
- **P2 (ì¤‘ê°„)**: ì¼ë¶€ ê¸°ëŠ¥ ë¶ˆê°€
- **P3 (ë‚®ìŒ)**: ì„±ëŠ¥ ì €í•˜

---

## 2. ì¥ì•  ìœ í˜•ë³„ ëŒ€ì‘

### [P0] ì„œë¹„ìŠ¤ ì „ì²´ ì¤‘ë‹¨

#### ì¦ìƒ
- ì›¹ì‚¬ì´íŠ¸ ì ‘ì† ë¶ˆê°€ (502 Bad Gateway, 504 Gateway Timeout)
- ëª¨ë“  API ìš”ì²­ ì‹¤íŒ¨

#### í™•ì¸ ì§€ì 
1. **Backend ì„œë²„ ìƒíƒœ**
   ```bash
   # í”„ë¡œì„¸ìŠ¤ í™•ì¸
   ps aux | grep java

   # í¬íŠ¸ í™•ì¸
   lsof -i :8080
   ```

2. **Nginx ìƒíƒœ**
   ```bash
   sudo systemctl status nginx
   ```

3. **MariaDB ìƒíƒœ**
   ```bash
   sudo systemctl status mariadb
   mysql -u app_user -p -e "SELECT 1"
   ```

#### ì¡°ì¹˜ ë°©ë²•

1. **Backend ì¬ì‹œì‘**
   ```bash
   kill -9 $(lsof -t -i:8080)
   java -jar closetconnectproject.jar &
   ```

2. **Nginx ì¬ì‹œì‘**
   ```bash
   sudo nginx -t
   sudo systemctl restart nginx
   ```

3. **MariaDB ì¬ì‹œì‘**
   ```bash
   sudo systemctl restart mariadb
   ```

4. **Health Check**
   ```bash
   curl http://localhost:8080/actuator/health
   ```

---

### [P1] ë¡œê·¸ì¸ ë¶ˆê°€

#### ì¦ìƒ
- ë¡œê·¸ì¸ ìš”ì²­ ì‹œ 401 Unauthorized
- "ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤" ì—ëŸ¬ ë©”ì‹œì§€

#### í™•ì¸ ì§€ì 
1. **JWT ì„¤ì • í™•ì¸**
   ```bash
   # í™˜ê²½ ë³€ìˆ˜ í™•ì¸
   echo $JWT_SECRET
   ```

2. **ë¡œê·¸ í™•ì¸**
   ```bash
   tail -f logs/spring.log | grep "JWT"
   ```

3. **DB ì‚¬ìš©ì í…Œì´ë¸” í™•ì¸**
   ```sql
   SELECT * FROM users WHERE email = 'test@test.com';
   ```

#### ì¡°ì¹˜ ë°©ë²•

1. **JWT Secret ì¬ì„¤ì •**
   ```bash
   export JWT_SECRET="new-secret-key"
   # ì„œë²„ ì¬ì‹œì‘
   ```

2. **ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”**
   ```sql
   -- BCrypt í•´ì‹œ ìƒì„± í›„
   UPDATE users SET password = '$2a$10$xxx' WHERE email = 'test@test.com';
   ```

---

### [P1] AI ì²˜ë¦¬ ì‹¤íŒ¨

#### ì¦ìƒ
- ì˜· ì—…ë¡œë“œ í›„ ì§„í–‰ë„ê°€ ë©ˆì¶¤
- "AI ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤" ì—ëŸ¬

#### í™•ì¸ ì§€ì 
1. **Python AI ì„œë²„ ìƒíƒœ**
   ```bash
   ps aux | grep python

   # ì„¸ê·¸ë©˜í…Œì´ì…˜ ì„œë²„
   lsof -i :8000

   # ì¸í˜ì¸íŒ… ì„œë²„
   lsof -i :8001
   ```

2. **RabbitMQ ìƒíƒœ**
   ```bash
   sudo rabbitmqctl status

   # í í™•ì¸
   sudo rabbitmqctl list_queues
   ```

3. **ë¡œê·¸ í™•ì¸**
   ```bash
   tail -f outputs/segmentation_server.log
   tail -f outputs/inpainting_server.log
   ```

#### ì¡°ì¹˜ ë°©ë²•

1. **AI ì„œë²„ ì¬ì‹œì‘**
   ```bash
   # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
   pkill -f cloth_segmentation_api
   pkill -f inpainting_api

   # ì¬ì‹œì‘
   cd aiModel
   python cloth_segmentation_api.py &
   python inpainting_api.py &
   ```

2. **RabbitMQ ì¬ì‹œì‘**
   ```bash
   sudo rabbitmqctl stop
   sudo rabbitmq-server &
   ```

3. **Dead Letter Queue í™•ì¸**
   ```bash
   sudo rabbitmqctl list_queues name messages
   # DLQì— ë©”ì‹œì§€ ìˆìœ¼ë©´ ì¬ì²˜ë¦¬ í•„ìš”
   ```

---

### [P1] ê²°ì œ ì‹¤íŒ¨

#### ì¦ìƒ
- ê²°ì œ ë²„íŠ¼ í´ë¦­ ì‹œ ì—ëŸ¬
- TossPayments í˜ì´ì§€ë¡œ ì´ë™ ì•ˆ ë¨

#### í™•ì¸ ì§€ì 
1. **TossPayments API ìƒíƒœ**
   ```bash
   curl https://api.tosspayments.com/v1/payments/healthcheck
   ```

2. **í™˜ê²½ ë³€ìˆ˜ í™•ì¸**
   ```bash
   echo $TOSS_SECRET_KEY
   ```

3. **ë¡œê·¸ í™•ì¸**
   ```bash
   tail -f logs/spring.log | grep "TossPayments"
   ```

#### ì¡°ì¹˜ ë°©ë²•

1. **Secret Key ì¬ì„¤ì •**
   ```bash
   export TOSS_SECRET_KEY="test_sk_xxx"
   # ì„œë²„ ì¬ì‹œì‘
   ```

2. **ì£¼ë¬¸ ìƒíƒœ í™•ì¸ ë° ìˆ˜ë™ ì²˜ë¦¬**
   ```sql
   SELECT * FROM market_order WHERE status = 'PENDING' AND created_at < NOW() - INTERVAL 30 MINUTE;

   -- 30ë¶„ ì´ìƒ PENDING ìƒíƒœë©´ ì·¨ì†Œ
   UPDATE market_order SET status = 'CANCELLED' WHERE id = 123;
   UPDATE market_product SET status = 'SALE' WHERE id = 456;
   ```

---

### [P2] ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨

#### ì¦ìƒ
- íŒŒì¼ ì—…ë¡œë“œ ì‹œ 500 ì—ëŸ¬
- "íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤"

#### í™•ì¸ ì§€ì 
1. **ë””ìŠ¤í¬ ìš©ëŸ‰ í™•ì¸**
   ```bash
   df -h
   ```

2. **ì—…ë¡œë“œ ë””ë ‰í† ë¦¬ ê¶Œí•œ í™•ì¸**
   ```bash
   ls -la ./uploads
   ```

3. **íŒŒì¼ í¬ê¸° ì œí•œ í™•ì¸**
   ```properties
   # application.properties
   spring.servlet.multipart.max-file-size=5MB
   spring.servlet.multipart.max-request-size=6MB
   ```

#### ì¡°ì¹˜ ë°©ë²•

1. **ë””ìŠ¤í¬ ì •ë¦¬**
   ```bash
   # ì˜¤ë˜ëœ ì„ì‹œ íŒŒì¼ ì‚­ì œ
   find ./uploads/temp -mtime +7 -delete
   ```

2. **ê¶Œí•œ ìˆ˜ì •**
   ```bash
   chmod 755 ./uploads
   chown -R app_user:app_user ./uploads
   ```

---

### [P2] WebSocket ì—°ê²° ì‹¤íŒ¨

#### ì¦ìƒ
- ì§„í–‰ë„ ì—…ë°ì´íŠ¸ ì•ˆ ë¨
- "WebSocket connection failed" ì½˜ì†” ì—ëŸ¬

#### í™•ì¸ ì§€ì 
1. **WebSocket ì—”ë“œí¬ì¸íŠ¸ í™•ì¸**
   ```bash
   curl -i -N -H "Connection: Upgrade" -H "Upgrade: websocket" http://localhost:8080/ws
   ```

2. **STOMP ì„¤ì • í™•ì¸**
   ```java
   // WebSocketConfig.java
   registry.addEndpoint("/ws").setAllowedOrigins("*");
   ```

#### ì¡°ì¹˜ ë°©ë²•

1. **CORS ì„¤ì • í™•ì¸**
   ```java
   // SecurityConfig.java
   config.addAllowedOrigin("http://localhost:5173");
   ```

2. **Nginx WebSocket Proxy ì„¤ì •**
   ```nginx
   location /ws {
       proxy_http_version 1.1;
       proxy_set_header Upgrade $http_upgrade;
       proxy_set_header Connection "Upgrade";
   }
   ```

---

### [P3] ì„±ëŠ¥ ì €í•˜

#### ì¦ìƒ
- API ì‘ë‹µ ì‹œê°„ 2ì´ˆ ì´ìƒ
- í˜ì´ì§€ ë¡œë”© ëŠë¦¼

#### í™•ì¸ ì§€ì 
1. **CPU/ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ **
   ```bash
   top
   htop
   ```

2. **DB ì»¤ë„¥ì…˜ í’€ ìƒíƒœ**
   ```bash
   curl http://localhost:8080/actuator/metrics/hikaricp.connections.active
   ```

3. **ìŠ¬ë¡œìš° ì¿¼ë¦¬ í™•ì¸**
   ```sql
   SHOW FULL PROCESSLIST;
   ```

#### ì¡°ì¹˜ ë°©ë²•

1. **DB ì¸ë±ìŠ¤ ì¶”ê°€**
   ```sql
   CREATE INDEX idx_cloth_user_id ON cloth(user_id);
   CREATE INDEX idx_post_board_id ON post(board_id);
   ```

2. **ì»¤ë„¥ì…˜ í’€ í¬ê¸° ì¦ê°€**
   ```properties
   spring.datasource.hikari.maximum-pool-size=20
   ```

3. **ìºì‹± ë„ì… (í–¥í›„)**
   ```java
   @Cacheable("clothes")
   public List<Cloth> findByUserId(Long userId) { ... }
   ```

---

## 3. ê¸´ê¸‰ ì—°ë½ë§

| ì—­í•  | ì´ë¦„ | ì—°ë½ì²˜ |
|------|------|--------|
| Backend ë‹´ë‹¹ | - | - |
| Frontend ë‹´ë‹¹ | - | - |
| AI ë‹´ë‹¹ | - | - |
| PM | - | - |

---

## 4. ì¥ì•  ë³´ê³  í…œí”Œë¦¿

```markdown
## ì¥ì•  ë³´ê³ 

**ë°œìƒ ì‹œê°„**: YYYY-MM-DD HH:MM
**í•´ê²° ì‹œê°„**: YYYY-MM-DD HH:MM
**ìš°ì„ ìˆœìœ„**: P0 / P1 / P2 / P3

### ì¦ìƒ
- êµ¬ì²´ì ì¸ ì¦ìƒ ê¸°ìˆ 

### ì›ì¸
- ê·¼ë³¸ ì›ì¸ ë¶„ì„

### ì¡°ì¹˜ ë‚´ìš©
- ì·¨í•œ ì¡°ì¹˜ ìƒì„¸

### ì¬ë°œ ë°©ì§€ ëŒ€ì±…
- í–¥í›„ ì˜ˆë°© ë°©ì•ˆ

### ì˜í–¥ ë²”ìœ„
- ì˜í–¥ë°›ì€ ì‚¬ìš©ì ìˆ˜
- ë°ì´í„° ì†ì‹¤ ì—¬ë¶€
```

---

## ë³€ê²½ ì´ë ¥

| ë‚ ì§œ | ë²„ì „ | ì‘ì„±ì | ë³€ê²½ ë‚´ìš© |
|------|------|--------|-----------|
| 2024-12-30 | 1.0 | Development Team | ì´ˆê¸° ë¬¸ì„œ ì‘ì„± |
