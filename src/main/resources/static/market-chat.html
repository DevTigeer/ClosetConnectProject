<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„íŒ… - ClosetConnect Market</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* ì±„íŒ…ë°© ëª©ë¡ */
        .chat-list {
            width: 350px;
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        .chat-list-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            background: #667eea;
            color: white;
        }

        .chat-list-header h2 {
            font-size: 20px;
        }

        .chat-rooms {
            flex: 1;
            overflow-y: auto;
        }

        .chat-room-item {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .chat-room-item:hover {
            background: #f8f9fa;
        }

        .chat-room-item.active {
            background: #e3f2fd;
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .room-user {
            font-weight: 600;
            color: #333;
        }

        .room-time {
            font-size: 12px;
            color: #999;
        }

        .room-product {
            font-size: 12px;
            color: #667eea;
            margin-bottom: 4px;
        }

        .room-last-message {
            font-size: 14px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .unread-badge {
            background: #e53935;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        /* ì±„íŒ… ì˜ì—­ */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 16px;
            display: flex;
        }

        .message.mine {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 60%;
            padding: 12px 16px;
            border-radius: 12px;
            word-wrap: break-word;
        }

        .message.mine .message-bubble {
            background: #667eea;
            color: white;
        }

        .message.other .message-bubble {
            background: white;
            color: #333;
        }

        .message.system .message-bubble {
            background: #fff3e0;
            color: #f57c00;
            max-width: 100%;
            text-align: center;
            font-size: 13px;
        }

        .message-info {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
        }

        .chat-input-area {
            padding: 16px 20px;
            border-top: 1px solid #e0e0e0;
            background: white;
        }

        .chat-input-form {
            display: flex;
            gap: 12px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 24px;
            font-size: 14px;
            font-family: inherit;
        }

        .send-button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 600;
        }

        .send-button:hover {
            background: #5568d3;
        }

        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #999;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #999;
        }
    </style>
</head>
<body>
    <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div style="background:#fff;padding:12px 20px;border-bottom:2px solid #eee;display:flex;gap:16px;justify-content:center;">
        <a href="/cloth/closet.html" style="text-decoration:none;color:#666;font-weight:500">ğŸ‘” ë‚´ ì˜·ì¥</a>
        <a href="/market-demo.html" style="text-decoration:none;color:#667eea;font-weight:600">ğŸ›’ ì¤‘ê³ ê±°ë˜</a>
        <a href="/commu/community.html" style="text-decoration:none;color:#666;font-weight:500">ğŸ’¬ ì»¤ë®¤ë‹ˆí‹°</a>
        <a href="/user/me.html" style="text-decoration:none;color:#666;font-weight:500">ğŸ‘¤ ë‚´ ì •ë³´</a>
    </div>

    <div class="container">
        <!-- ì±„íŒ…ë°© ëª©ë¡ -->
        <div class="chat-list">
            <div class="chat-list-header">
                <h2>ğŸ’¬ ì±„íŒ…</h2>
                <div style="font-size:12px; margin-top:4px;">
                    <a href="market-demo.html" style="color:white;">â† ëª©ë¡ìœ¼ë¡œ</a>
                </div>
            </div>
            <div class="chat-rooms" id="chatRoomsList">
                <div class="loading">ì±„íŒ…ë°©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>

        <!-- ì±„íŒ… ì˜ì—­ -->
        <div class="chat-area">
            <div id="chatArea">
                <div class="empty-state">
                    <div>ì±„íŒ…ë°©ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8080/api/v1';
        const WS_URL = 'http://localhost:8080/ws';

        let stompClient = null;
        let currentRoomId = null;
        let currentUserId = null;

        function getToken() {
            return localStorage.getItem('jwt_token');
        }

        function getUserIdFromToken() {
            const token = getToken();
            if (!token) return null;
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                return payload.uid; // JWT í† í°ì˜ ì‹¤ì œ í‚¤ëŠ” 'uid'
            } catch (e) {
                return null;
            }
        }

        window.onload = function() {
            const token = getToken();
            if (!token) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                location.href = 'login.html';
                return;
            }

            currentUserId = getUserIdFromToken();

            // URL íŒŒë¼ë¯¸í„°ì—ì„œ roomId í™•ì¸
            const urlParams = new URLSearchParams(window.location.search);
            const roomIdFromUrl = urlParams.get('roomId');

            loadChatRooms(roomIdFromUrl);
            connectWebSocket();
        };

        // WebSocket ì—°ê²°
        function connectWebSocket() {
            const token = getToken();
            const socket = new SockJS(WS_URL);
            stompClient = Stomp.over(socket);

            stompClient.connect({ 'Authorization': `Bearer ${token}` }, function() {
                console.log('WebSocket ì—°ê²° ì„±ê³µ');
            }, function(error) {
                console.error('WebSocket ì—°ê²° ì‹¤íŒ¨:', error);
            });
        }

        // ì±„íŒ…ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadChatRooms(autoOpenRoomId = null) {
            const token = getToken();
            const container = document.getElementById('chatRoomsList');

            try {
                const response = await fetch(`${API_BASE_URL}/market/chat/rooms`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('ì±„íŒ…ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

                const rooms = await response.json();
                displayChatRooms(rooms);

                // URL íŒŒë¼ë¯¸í„°ë¡œ roomIdê°€ ì „ë‹¬ëœ ê²½ìš° ìë™ìœ¼ë¡œ ì—´ê¸°
                if (autoOpenRoomId) {
                    const roomExists = rooms.find(r => r.roomId == autoOpenRoomId);
                    if (roomExists) {
                        setTimeout(() => {
                            const roomElements = document.querySelectorAll('.chat-room-item');
                            const targetRoomElement = Array.from(roomElements).find(el => {
                                return el.onclick.toString().includes(autoOpenRoomId);
                            });
                            if (targetRoomElement) {
                                targetRoomElement.click();
                            }
                        }, 100);
                    }
                }
            } catch (error) {
                container.innerHTML = `<div class="loading">âŒ ${error.message}</div>`;
            }
        }

        // ì±„íŒ…ë°© ëª©ë¡ í‘œì‹œ
        function displayChatRooms(rooms) {
            const container = document.getElementById('chatRoomsList');

            if (rooms.length === 0) {
                container.innerHTML = '<div class="loading">ì±„íŒ… ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            container.innerHTML = '';
            rooms.forEach(room => {
                const item = document.createElement('div');
                item.className = 'chat-room-item';
                item.onclick = () => openChatRoom(room.roomId);

                const timeStr = room.lastMessageAt ?
                    new Date(room.lastMessageAt).toLocaleString('ko-KR', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) :
                    '';

                item.innerHTML = `
                    <div class="room-header">
                        <span class="room-user">${room.otherUserNickname}</span>
                        <div>
                            ${room.unreadCount > 0 ? `<span class="unread-badge">${room.unreadCount}</span>` : ''}
                            <span class="room-time">${timeStr}</span>
                        </div>
                    </div>
                    <div class="room-product">${room.productTitle}</div>
                    <div class="room-last-message">${room.lastMessage || 'ë©”ì‹œì§€ ì—†ìŒ'}</div>
                `;

                container.appendChild(item);
            });
        }

        // ì±„íŒ…ë°© ì—´ê¸°
        async function openChatRoom(roomId) {
            currentRoomId = roomId;

            // í™œì„± í‘œì‹œ
            document.querySelectorAll('.chat-room-item').forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');

            // ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°
            await loadMessages(roomId);

            // WebSocket êµ¬ë…
            if (stompClient && stompClient.connected) {
                stompClient.subscribe(`/queue/chat/${roomId}`, function(message) {
                    const msg = JSON.parse(message.body);
                    appendMessage(msg);
                });
            }

            // ì½ìŒ ì²˜ë¦¬
            markAsRead(roomId);
        }

        // ë©”ì‹œì§€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadMessages(roomId) {
            const token = getToken();
            const chatArea = document.getElementById('chatArea');

            try {
                const response = await fetch(`${API_BASE_URL}/market/chat/rooms/${roomId}/messages`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

                const messages = await response.json();
                displayMessages(messages);
            } catch (error) {
                chatArea.innerHTML = `<div class="empty-state">âŒ ${error.message}</div>`;
            }
        }

        // ë©”ì‹œì§€ ëª©ë¡ í‘œì‹œ
        function displayMessages(messages) {
            const chatArea = document.getElementById('chatArea');

            chatArea.innerHTML = `
                <div class="chat-header">
                    <div class="chat-title">ì±„íŒ…</div>
                </div>
                <div class="chat-messages" id="messagesContainer"></div>
                <div class="chat-input-area">
                    <form class="chat-input-form" onsubmit="sendMessage(event)">
                        <input type="text" class="chat-input" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
                        <button type="submit" class="send-button">ì „ì†¡</button>
                    </form>
                </div>
            `;

            messages.forEach(msg => appendMessage(msg));
            scrollToBottom();
        }

        // ë©”ì‹œì§€ ì¶”ê°€
        function appendMessage(msg) {
            const container = document.getElementById('messagesContainer');
            if (!container) return;

            const div = document.createElement('div');
            div.className = 'message';

            if (msg.messageType === 'SYSTEM') {
                div.classList.add('system');
            } else if (msg.senderId === currentUserId) {
                div.classList.add('mine');
            } else {
                div.classList.add('other');
            }

            const time = new Date(msg.createdAt).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

            div.innerHTML = `
                <div class="message-bubble">
                    ${msg.content}
                    <div class="message-info">${time}</div>
                </div>
            `;

            container.appendChild(div);
            scrollToBottom();
        }

        // ë©”ì‹œì§€ ì „ì†¡
        function sendMessage(event) {
            event.preventDefault();

            if (!currentRoomId) {
                alert('ì±„íŒ…ë°©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            if (!content) return;

            const message = {
                roomId: currentRoomId,
                messageType: 'TEXT',
                content: content
            };

            if (stompClient && stompClient.connected) {
                stompClient.send('/app/chat.send', {}, JSON.stringify(message));
                input.value = '';
            } else {
                alert('ì±„íŒ… ì„œë²„ì™€ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.');
            }
        }

        // ì½ìŒ ì²˜ë¦¬
        async function markAsRead(roomId) {
            const token = getToken();
            try {
                await fetch(`${API_BASE_URL}/market/chat/rooms/${roomId}/read`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
            } catch (error) {
                console.error('ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
            }
        }

        // ìŠ¤í¬ë¡¤ ì•„ë˜ë¡œ
        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        }
    </script>
</body>
</html>
