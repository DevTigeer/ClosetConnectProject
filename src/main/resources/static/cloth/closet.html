<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>Closet | ClosetConnect</title>
    <link rel="stylesheet" href="/css/closet.css">
    <style>
        body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#fafafa;}
        .wrap{display:grid;grid-template-columns:220px 1fr 420px; gap:24px; max-width:1280px; margin:40px auto;}
        .sidebar{background:#eee;border-radius:12px;padding:16px;height:calc(100vh - 120px);position:sticky;top:40px}
        .section{background:#fff;border-radius:12px;padding:18px 20px;box-shadow:0 6px 18px rgba(0,0,0,.05);margin-bottom:18px}
        .slot{display:flex;align-items:center;gap:18px;padding:16px 0;border-bottom:1px solid #f0f0f0}
        .slot:last-child{border-bottom:0}
        .arrow{width:44px;height:44px;border-radius:50%;border:1px solid #ddd;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;background:#fff}
        .thumb{width:120px;height:120px;border-radius:10px;object-fit:cover;background:#f6f6f6;border:1px solid #eee}
        .right{background:#fff;border-radius:12px;padding:18px 20px;box-shadow:0 6px 18px rgba(0,0,0,.05)}
        .preview{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:12px;border:1px solid #eee;background:#f8f8f8}
        .btn{padding:10px 14px;border:0;border-radius:8px;background:#222;color:#fff;cursor:pointer}
        .muted{color:#666;font-size:12px}
        /* 미니 팝업(드롭오버) */
        .popover{position:absolute;z-index:50;background:#fff;border:1px solid #e6e6e6;border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,.12);padding:12px;display:none}
        .grid{display:grid;grid-template-columns:repeat(4, 90px); gap:10px}
        .item{display:flex;flex-direction:column;gap:6px;cursor:pointer}
        .item img{width:90px;height:90px;object-fit:cover;border-radius:8px;border:1px solid #eee;background:#f7f7f7}
        .topbar{grid-column:1/-1;display:flex;gap:8px;margin-bottom:6px}
        .tab{padding:8px 10px;border:1px solid #ddd;background:#fafafa;border-radius:8px;cursor:pointer;font-size:12px}
        .tab.active{background:#222;color:#fff;border-color:#222}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<div class="wrap">
    <!-- 왼쪽 사이드 -->
    <aside class="sidebar">
        <div style="font-weight:700;margin-bottom:12px">Menu</div>
        <div class="muted">Logo</div>
        <div class="muted" style="margin-top:8px">Closet</div>
        <div class="muted" style="margin-top:8px">Suggest</div>
        <div class="muted" style="margin-top:8px">Community</div>
        <div class="muted" style="margin-top:8px">myPage</div>
        <hr style="margin:12px 0;border:none;border-top:1px solid #ddd"/>
        <button class="btn" id="logoutBtn">로그아웃</button>
    </aside>

    <!-- 중앙: 카테고리 슬롯 -->
    <main>
        <div class="section">
            <div style="display:flex;gap:8px;margin-bottom:12px">
                <button class="tab active" data-tab="OOTD">OOTD</button>
                <button class="tab" data-tab="Today">Today Weather</button>
                <button class="tab" data-tab="Matched">Matched Item</button>
            </div>

            <!-- Suggest/ACC -->
            <div class="slot" data-category="ACC">
                <button class="arrow" data-dir="prev">←</button>
                <img class="thumb" alt="ACC" src="" />
                <button class="arrow" data-dir="next">→</button>
                <div class="muted">Acc</div>
            </div>

            <!-- TOP -->
            <div class="slot" data-category="TOP">
                <button class="arrow" data-dir="prev">←</button>
                <img class="thumb" alt="TOP" src="" />
                <button class="arrow" data-dir="next">→</button>
                <div class="muted">Top</div>
            </div>

            <!-- BOTTOM -->
            <div class="slot" data-category="BOTTOM">
                <button class="arrow" data-dir="prev">←</button>
                <img class="thumb" alt="BOTTOM" src="" />
                <button class="arrow" data-dir="next">→</button>
                <div class="muted">Bottom</div>
            </div>

            <!-- SHOES -->
            <div class="slot" data-category="SHOES">
                <button class="arrow" data-dir="prev">←</button>
                <img class="thumb" alt="SHOES" src="" />
                <button class="arrow" data-dir="next">→</button>
                <div class="muted">Shoes</div>
            </div>
        </div>
    </main>

    <!-- 오른쪽: 미리보기 패널 -->
    <aside class="right">
        <div class="muted">Suggest Item</div>
        <img id="previewImage" class="preview" alt="preview"/>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
            <div id="previewName" class="muted">선택된 항목 없음</div>
            <button id="okBtn" class="btn" disabled>OK</button>
        </div>
    </aside>
</div>

<!-- 미니 팝업 템플릿 -->
<div id="popover" class="popover">
    <div class="grid">
        <!-- JS로 썸네일 주입 -->
    </div>
</div>

<script>
    // 공통 axios 인스턴스
    window.API_BASE = '/api/v1';

    window.api = axios.create({
        baseURL: API_BASE,
        headers: { 'Content-Type': 'application/json' }
    });

    // 요청 인터셉터: 토큰 부착
    api.interceptors.request.use((cfg) => {
        const t = localStorage.getItem('accessToken');
        if (t) cfg.headers.Authorization = `Bearer ${t}`;
        return cfg;
    });

    // 응답 인터셉터: 401 → 로그인으로
    api.interceptors.response.use(
        (res) => res,
        (err) => {
            if (err.response?.status === 401) {
                alert('다시 로그인 해주세요.');
                location.href = '/auth/login.html';
            }
            return Promise.reject(err);
        }
    );
</script>

<script>
    // ------- 상태 -------
    const CATEGORIES = ['ACC','TOP','BOTTOM','SHOES'];
    const state = {
        cursor: { ACC:0, TOP:0, BOTTOM:0, SHOES:0 },
        items:  { ACC:[], TOP:[], BOTTOM:[], SHOES:[] },
        preview: null,           // {id,name,imageUrl,category,...}
        previewCategory: null
    };

    const $popover = document.getElementById('popover');
    const $grid    = $popover.querySelector('.grid');
    const $preview = document.getElementById('previewImage');
    const $name    = document.getElementById('previewName');
    const $ok      = document.getElementById('okBtn');

    // ------- 초기 로드: 각 카테고리 1페이지 프리페치 -------
    async function loadFirstPage(category){
        const res = await api.get('/cloth', { params: { category, size:12, page:0 }});
        state.items[category] = res.data?.content ?? res.data ?? []; // 둘 중 하나 형태 대응
        // 첫 이미지 썸네일 반영
        const first = state.items[category][0];
        const slotImg = document.querySelector(`.slot[data-category="${category}"] .thumb`);
        if (first && slotImg){
            slotImg.src = first.imageUrl || '';
            slotImg.dataset.id = first.id;
            slotImg.dataset.name = first.name || '';
        }
    }
    (async () => {
        for (const c of CATEGORIES) {
            try { await loadFirstPage(c); } catch(e){ console.warn(c, e); }
        }
    })();

    // ------- 팝업 열기 -------
    function openPopover(anchorBtn, category){
        // 위치 계산
        const rect = anchorBtn.getBoundingClientRect();
        $popover.style.left = (window.scrollX + rect.right + 8) + 'px';
        $popover.style.top  = (window.scrollY + rect.top   - 6) + 'px';
        // 그리드 채우기
        $grid.innerHTML = '';
        const list = state.items[category] || [];
        list.forEach(item => {
            const div = document.createElement('div');
            div.className = 'item';
            div.dataset.id = item.id;
            div.dataset.category = category;
            div.innerHTML = `
        <img src="${item.imageUrl || ''}" alt="">
        <div class="muted" style="font-size:11px">${item.name || ''}</div>
      `;
            // hover → 우측 미리보기
            div.addEventListener('mouseenter', () => selectPreview(item, category));
            // click → 확정 후보로 세팅 후 OK 활성
            div.addEventListener('click', () => {
                selectPreview(item, category);
                $ok.disabled = false;
            });
            $grid.appendChild(div);
        });
        $popover.style.display = 'block';
        state.previewCategory = category;
    }

    // ------- 팝업 닫기 -------
    function closePopover(){
        $popover.style.display = 'none';
    }
    document.addEventListener('click', (e)=>{
        if (!$popover.contains(e.target) && !e.target.classList.contains('arrow')) {
            closePopover();
        }
    });

    // ------- 미리보기 선택 -------
    function selectPreview(item, category){
        state.preview = item;
        $preview.src = item.imageUrl || '';
        $name.textContent = (item.name || '') + (category ? ` · ${category}` : '');
    }

    // ------- OK: 썸네일 교체만 (서버 확정 API 아직 없으니 로컬 반영) -------
    $ok.addEventListener('click', ()=>{
        if (!state.preview || !state.previewCategory) return;
        const { preview, previewCategory:cat } = state;
        const slotImg = document.querySelector(`.slot[data-category="${cat}"] .thumb`);
        if (slotImg){
            slotImg.src = preview.imageUrl || '';
            slotImg.dataset.id = preview.id;
            slotImg.dataset.name = preview.name || '';
        }
        $ok.disabled = true;
        closePopover();
    });

    // ------- 좌/우 버튼 동작 -------
    document.querySelectorAll('.slot .arrow').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
            const slot = e.currentTarget.closest('.slot');
            const category = slot.dataset.category;
            const dir = e.currentTarget.dataset.dir;

            // 데이터 없으면 로드
            if (!state.items[category] || state.items[category].length === 0) {
                await loadFirstPage(category);
            }

            if (dir === 'prev') {
                // 캐러셀 이전
                const list = state.items[category];
                if (list.length === 0) return;
                state.cursor[category] = (state.cursor[category] - 1 + list.length) % list.length;
                const cur = list[state.cursor[category]];
                const img = slot.querySelector('.thumb');
                img.src = cur.imageUrl || '';
                img.dataset.id = cur.id;
                img.dataset.name = cur.name || '';
                // 우측 미리보기는 건드리지 않음
            } else {
                // 다음(추천/후보 보기) → 팝업 오픈
                openPopover(e.currentTarget, category);
            }
        });
    });

    // 탭(현재는 표시만)
    document.querySelectorAll('.tab').forEach(t=>{
        t.addEventListener('click', ()=>{
            document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
            t.classList.add('active');
        });
    });

    // 로그아웃
    document.getElementById('logoutBtn').addEventListener('click', ()=>{
        localStorage.removeItem('accessToken');
        location.href = '/auth/login.html';
    });
</script>
</body>
</html>
