<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Closet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        :root { --gap:14px; --card:160px; }
        *{box-sizing:border-box}
        body{margin:0;background:#fafafa;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif;color:#222}
        header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #eee;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
        h1{margin:0;font-size:18px}
        .btn{padding:8px 10px;border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer}
        .btn:hover{background:#f6f6f6}
        .btn-row{display:flex;gap:8px}
        main{padding:18px}
        .section{margin-bottom:28px}
        .sec-title{font-weight:600;margin:0 0 10px 4px}
        .row{position:relative;background:#fff;border:1px solid #eee;border-radius:12px;padding:14px}
        .strip{display:flex;gap:var(--gap);overflow:hidden;scroll-behavior:smooth}
        .card{min-width:var(--card);max-width:var(--card);border:1px solid #eee;border-radius:10px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.05);position:relative;cursor:pointer}
        .thumb{width:100%;aspect-ratio:1/1;object-fit:cover;background:#f0f0f0;border-top-left-radius:10px;border-top-right-radius:10px}
        .meta{padding:8px 10px;font-size:12px;color:#444;display:flex;justify-content:space-between}
        .arrow{position:absolute;top:50%;transform:translateY(-50%);width:38px;height:38px;border-radius:50%;border:1px solid #e6e6e6;background:#f3f3f3;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .arrow:hover{background:#ececec}
        .left{left:8px} .right{right:8px}
        /* ì‚­ì œëª¨ë“œ ì²´í¬ë°•ìŠ¤ */
        .check{position:absolute;top:8px;left:8px;transform:scale(1.3);display:none}
        .delete-mode .check{display:block}
        /* ëª¨ë‹¬ */
        .modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);align-items:center;justify-content:center}
        .modal{background:#fff;border-radius:12px;max-width:440px;width:92%;padding:18px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
        .modal h3{margin:8px 0}
        .modal img{width:100%;border-radius:8px;margin-bottom:8px}
        .close{float:right;border:none;background:#eee;border-radius:8px;padding:6px 10px;cursor:pointer}
        form label{display:block;margin:8px 0 4px;font-size:13px}
        form input,form select{width:100%;padding:8px;border:1px solid #ccc;border-radius:8px}

        /* ë„¤ë¹„ê²Œì´ì…˜ íƒ­ */
        .nav-tabs{background:#fff;border-bottom:2px solid #eee;display:flex;justify-content:center;gap:0;padding:0 16px;position:sticky;top:52px;z-index:9}
        .nav-tab{padding:14px 24px;border:none;background:transparent;cursor:pointer;font-size:15px;font-weight:500;color:#666;border-bottom:3px solid transparent;transition:all 0.2s}
        .nav-tab:hover{color:#333;background:#f8f8f8}
        .nav-tab.active{color:#667eea;border-bottom-color:#667eea}
    </style>
</head>
<body>
<header>
    <h1>ğŸ  ClosetConnect</h1>
    <div class="btn-row">
        <button id="wearBtn" class="btn">Wear</button>
        <button id="deleteBtn" class="btn">Delete</button>
        <button id="addBtn" class="btn">Add</button>
    </div>
</header>

<!-- ë„¤ë¹„ê²Œì´ì…˜ íƒ­ -->
<nav class="nav-tabs">
    <button class="nav-tab active" onclick="location.href='/cloth/closet.html'">ğŸ‘” ë‚´ ì˜·ì¥</button>
    <button class="nav-tab" onclick="location.href='/market-demo.html'">ğŸ›’ ì¤‘ê³ ê±°ë˜</button>
    <button class="nav-tab" onclick="location.href='/commu/community.html'">ğŸ’¬ ì»¤ë®¤ë‹ˆí‹°</button>
    <button class="nav-tab" onclick="location.href='/weather-with-recommendation.html'">ğŸŒ¤ï¸ ë‚ ì”¨</button>
    <button class="nav-tab" onclick="location.href='/user/me.html'">ğŸ‘¤ ë‚´ ì •ë³´</button>
</nav>

<main id="root"></main>

<!-- ìƒì„¸ ëª¨ë‹¬ -->
<div id="detailModal" class="modal-bg">
    <div class="modal">
        <button class="close" onclick="closeModal('detailModal')">ë‹«ê¸°</button>
        <img id="dImg" src="" alt="">
        <h3 id="dName"></h3>
        <p>ì¹´í…Œê³ ë¦¬: <span id="dCat"></span></p>
        <p>ë“±ë¡ì¼: <span id="dDate"></span></p>
    </div>
</div>

<!-- ìƒí’ˆ ì¶”ê°€ ëª¨ë‹¬ -->
<div id="addModal" class="modal-bg">
    <div class="modal">
        <button class="close" onclick="closeModal('addModal')">ë‹«ê¸°</button>
        <h3>ìƒí’ˆ ì¶”ê°€</h3>
        <form id="addForm">
            <label>ì´ë¯¸ì§€ íŒŒì¼</label>
            <input type="file" id="uploadFile" accept="image/*" />

            <img id="preview" style="width:100%;margin:8px 0;display:none;border-radius:8px;">

            <label>ì´ë¦„</label>
            <input name="name" required />

            <label>ì¹´í…Œê³ ë¦¬</label>
            <select name="category" required>
                <option value="TOP">TOP</option>
                <option value="BOTTOM">BOTTOM</option>
                <option value="OUTER">OUTER</option>
                <option value="ONEPIECE">ONEPIECE</option>
                <option value="SHOES">SHOES</option>
                <option value="BAG">BAG</option>
                <option value="ACCESSORY">ACCESSORY</option>
                <option value="ETC">ETC</option>
            </select>

            <button class="btn" type="submit" style="margin-top:10px">ë“±ë¡</button>
        </form>
    </div>
</div>

<script>
    function getAuthHeader() {
        const raw = localStorage.getItem('jwt_token') || '';
        if (!raw) return '';                               // í† í° ì—†ìŒ
        return raw.startsWith('Bearer ') ? raw : `Bearer ${raw}`;
    }

    // ëª¨ë“  ìš”ì²­ì— ìë™ìœ¼ë¡œ Authorization ì£¼ì…
    axios.interceptors.request.use(cfg => {
        const auth = getAuthHeader();
        if (auth) cfg.headers.Authorization = auth;
        return cfg;
    });

    // í˜ì´ì§€ ì§„ì… ì‹œ í† í° ì—†ìœ¼ë©´ ì•ˆë‚´(ì›í•˜ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™)
    if (!getAuthHeader()) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. í† í°ì´ ë¹„ì–´ìˆì–´ìš”.');
        // window.location.href = '/login.html'; // ì‚¬ìš© ì¤‘ì¸ ë¡œê·¸ì¸ í˜ì´ì§€ ìˆìœ¼ë©´ ì£¼ì„ í•´ì œ
    }
    const API = 'http://localhost:8080';
    const PAGE_SIZE_FOR_FETCH_ALL = 1000; // í•œ ë²ˆì— ë‹¤ ê°€ì ¸ì˜¤ê¸°
    const DISPLAY_NAME = {
        TOP:'Top', BOTTOM:'Bottom', OUTER:'Outer', ONEPIECE:'Onepiece',
        SHOES:'Shoes', BAG:'Bag', ACCESSORY:'Acc', ETC:'Etc'
    };

    let deleteMode = false;

         // íŒŒì¼ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸°ë§Œ í‘œì‹œ (ì„œë²„ ì—…ë¡œë“œëŠ” ë“±ë¡ ì‹œì ì—)
         document.getElementById('uploadFile').addEventListener('change', async (e) => {
           const file = e.target.files[0];
           if (!file) return;

           // ë¡œì»¬ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
           const reader = new FileReader();
           reader.onload = (evt) => {
             const prev = document.getElementById('preview');
             prev.src = evt.target.result;
             prev.style.display = 'block';
           };
           reader.readAsDataURL(file);
         });

function token(){ return localStorage.getItem('token') || ''; }
    function abs(url){ return url?.startsWith('http') ? url : `${API}${url}`; }

    async function fetchAll() {
        const res = await axios.get(`${API}/api/v1/cloth`, {
            headers:{ Authorization:`Bearer ${token()}` },
            params:{ page:0, size: PAGE_SIZE_FOR_FETCH_ALL }
        });
        return res.data.content || [];
    }

    function groupByCategory(items){
        const map = {TOP:[],BOTTOM:[],OUTER:[],ONEPIECE:[],SHOES:[],BAG:[],ACCESSORY:[],ETC:[]};
        items.forEach(it => { (map[it.category] ??= []).push(it); });
        return map;
    }

    function makeSection(cat, items){
        const sec = document.createElement('section');
        sec.className = 'section';
        sec.innerHTML = `<h3 class="sec-title">${DISPLAY_NAME[cat]}</h3>`;
        const row = document.createElement('div');
        row.className = 'row';
        const strip = document.createElement('div');
        strip.className = 'strip';
        strip.dataset.cat = cat;

        items.forEach(it=>{
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
          <input type="checkbox" class="check" data-id="${it.id}">
          <img class="thumb" src="${abs(it.imageUrl)}" alt="">
          <div class="meta"><span>${it.name ?? ''}</span><span style="color:#888">${it.category}</span></div>
        `;
            card.addEventListener('click', e=>{
                if(deleteMode) return;
                openDetail(it);
            });
            strip.appendChild(card);
        });

        // ì¢Œìš° í™”ì‚´í‘œ
        const left = document.createElement('button');
        left.className = 'arrow left'; left.textContent = 'â€¹';
        left.onclick = () => slide(strip, -1);

        const right = document.createElement('button');
        right.className = 'arrow right'; right.textContent = 'â€º';
        right.onclick = () => slide(strip, +1);

        row.appendChild(left);
        row.appendChild(strip);
        row.appendChild(right);
        sec.appendChild(row);
        return sec;
    }

    function slide(strip, dir){
        // ì¹´ë“œ í•˜ë‚˜ í­ + gap ë§Œí¼ë§Œ ì´ë™
        const card = strip.querySelector('.card');
        if(!card) return;
        const gap = parseFloat(getComputedStyle(strip).columnGap || getComputedStyle(strip).gap || 14);
        const step = card.getBoundingClientRect().width + gap;
        strip.scrollBy({ left: dir * step, behavior:'smooth' });
    }

    function renderAll(grouped){
        const root = document.getElementById('root');
        root.innerHTML = '';
        Object.keys(DISPLAY_NAME).forEach(cat=>{
            const arr = grouped[cat] || [];
            if(arr.length === 0) return;
            root.appendChild(makeSection(cat, arr));
        });
        document.body.classList.toggle('delete-mode', deleteMode);
    }

    // ìƒì„¸
    function openDetail(it){
        document.getElementById('dImg').src = abs(it.imageUrl);
        document.getElementById('dName').textContent = it.name ?? '';
        document.getElementById('dCat').textContent  = it.category ?? '';
        document.getElementById('dDate').textContent = (it.createdAt||'').split('T')[0] || '';
        document.getElementById('detailModal').style.display='flex';
    }
    function closeModal(id){ document.getElementById(id).style.display='none'; }

    // ë²„íŠ¼ë“¤
    document.getElementById('wearBtn').onclick = ()=> alert('WearëŠ” ì¶”í›„ ì—°ê²°í• ê²Œ!');

    document.getElementById('deleteBtn').onclick = async ()=>{
        if(!deleteMode){
            deleteMode = true;
            document.body.classList.add('delete-mode');
            document.getElementById('deleteBtn').textContent = 'Delete Selected';
            return;
        }
        // ì„ íƒ ì‚­ì œ ì‹¤í–‰
        const ids = [...document.querySelectorAll('.check:checked')].map(c=>c.dataset.id);
        if(ids.length===0){ deleteMode=false; document.body.classList.remove('delete-mode'); document.getElementById('deleteBtn').textContent='Delete'; return; }
        if(!confirm(`${ids.length}ê°œ ì‚­ì œí• ê¹Œìš”?`)) return;
        for(const id of ids){
            await axios.delete(`${API}/api/v1/cloth/${id}`, { headers:{ Authorization:`Bearer ${token()}` } });
        }
        deleteMode=false;
        document.body.classList.remove('delete-mode');
        document.getElementById('deleteBtn').textContent='Delete';
        await boot(); // ìƒˆë¡œê³ ì¹¨
    };

    document.getElementById('addBtn').onclick = ()=> document.getElementById('addModal').style.display='flex';
    document.getElementById('addForm').onsubmit = async (e)=>{
        e.preventDefault();
        const f = e.target;
        const fileInput = document.getElementById('uploadFile');

        if (!fileInput.files || !fileInput.files[0]) {
            alert('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        // FormData ìƒì„±: image, name, categoryë¥¼ í•¨ê»˜ ì „ì†¡
        const formData = new FormData();
        formData.append('image', fileInput.files[0]);
        formData.append('name', f.name.value);
        formData.append('category', f.category.value);

        try{
            // /upload ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš© (ìë™ ë°°ê²½ ì œê±° ì²˜ë¦¬)
            await axios.post(`${API}/api/v1/cloth/upload`, formData, {
                headers:{
                    Authorization:`Bearer ${token()}`,
                    'Content-Type':'multipart/form-data'
                }
            });

            f.reset();
            fileInput.value = '';
            const prev = document.getElementById('preview');
            prev.style.display = 'none';
            closeModal('addModal');
            await boot();
        }catch(err){
            console.error(err.response?.data || err);
            alert('ë“±ë¡ ì‹¤íŒ¨: ' + (err.response?.data?.message || err.message));
        }
    };

    async function boot(){
        const items = await fetchAll(); // í•œ ë²ˆì— ì „ë¶€
        const grouped = groupByCategory(items);
        renderAll(grouped);
    }

    boot();
</script>
</body>
</html>
