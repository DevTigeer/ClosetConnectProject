<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>글쓰기</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body{margin:0;background:#fafafa;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif}
        header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:12px 16px;display:flex;align-items:center;gap:8px}
        .btn{padding:8px 10px;border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer}
        .wrap{padding:16px;max-width:800px;margin:0 auto}
        form{background:#fff;border:1px solid #eee;border-radius:12px;padding:12px;display:grid;gap:8px}
        input,textarea,select{padding:8px;border:1px solid #ddd;border-radius:8px}
    </style>
</head>
<body>
<header>
    <a class="btn" id="backBtn">← 뒤로</a>
    <strong id="boardName">글쓰기</strong>
</header>

<main class="wrap">
    <form id="form">
        <input id="title" placeholder="제목" required />
        <select id="visibility">
            <option value="PUBLIC">PUBLIC</option>
            <option value="PRIVATE">PRIVATE</option>
        </select>
        <textarea id="content" rows="10" placeholder="내용"></textarea>
        <div style="text-align:right"><button class="btn" type="submit">작성</button></div>
    </form>
</main>

<script>
    (function(){
        'use strict';
        const token = localStorage.getItem('accessToken');
        const slug = new URLSearchParams(location.search).get('slug');

        if (!slug) { alert('slug 누락'); location.href = '/commu/'; return; }
        if (!token) { alert('로그인이 필요합니다'); location.href = '/auth/login.html'; return; }

        axios.defaults.withCredentials = false;
        axios.defaults.headers.common['Authorization'] = token.startsWith('Bearer ') ? token : `Bearer ${token}`;

        const getBoardBySlug = async (slug) => (await axios.get(`/api/v1/community/boards/${encodeURIComponent(slug)}`)).data;
        const createPost = async ({boardId, payload}) => (await axios.post(`/api/v1/boards/${boardId}/posts`, payload)).data;

        (async ()=>{
            try {
                const board = await getBoardBySlug(slug);
                document.getElementById('boardName').textContent = `${board.name} · 글쓰기`;
                document.getElementById('backBtn').onclick = () => location.href = `/commu/board.html?slug=${encodeURIComponent(slug)}`;

                document.getElementById('form').addEventListener('submit', async (e)=>{
                    e.preventDefault();
                    const payload = {
                        title: document.getElementById('title').value.trim(),
                        content: document.getElementById('content').value,
                        visibility: document.getElementById('visibility').value
                    };
                    if (!payload.title) { alert('제목 필수'); return; }
                    try{
                        const created = await createPost({ boardId: board.id, payload });
                        location.href = `/commu/post.html?id=${created.id}`;
                    }catch(err){
                        console.error(err);
                        alert('작성 실패');
                    }
                });
            } catch (e) {
                console.error(e);
                alert('보드 정보를 불러오지 못했습니다.');
            }
        })();
    })();
</script>
</body>
</html>
