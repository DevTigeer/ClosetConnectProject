<!-- src/main/resources/static/post.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Post</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body{margin:0;background:#fafafa;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif}
        header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:12px 16px;display:flex;align-items:center;gap:8px}
        .btn{padding:8px 10px;border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer}
        .wrap{padding:16px;max-width:900px;margin:0 auto}
        .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:14px;margin-bottom:12px}
        input,textarea{padding:8px;border:1px solid #ddd;border-radius:8px;width:100%}
        .row{display:flex;gap:8px;align-items:center}
        .att{display:flex;gap:8px;flex-wrap:wrap}
        .chip{border:1px solid #ddd;border-radius:999px;padding:4px 8px;background:#fff}
    </style>
</head>
<body>
<header>
    <a class="btn" href="javascript:history.back()">â† ë’¤ë¡œ</a>
    <strong id="titleTop"></strong>
</header>

<main class="wrap">
    <article class="card">
        <h2 id="title"></h2>
        <div id="meta" style="color:#888;font-size:12px"></div>
        <div id="content" style="white-space:pre-wrap; margin-top:8px"></div>

        <div class="row" style="gap:12px;margin-top:10px">
            <button id="likeBtn" class="btn">â¤ï¸ ì¢‹ì•„ìš”</button>
            <button id="unlikeBtn" class="btn">ğŸ’” ì·¨ì†Œ</button>
            <button id="delBtn" class="btn">ğŸ—‘ï¸ ì‚­ì œ</button>
        </div>

        <div style="margin-top:10px">
            <div style="font-weight:600;margin-bottom:6px">ì²¨ë¶€</div>
            <div class="att" id="attList"></div>
            <div class="row" style="margin-top:8px">
                <input id="file" type="file" accept="image/*" style="flex:1">
                <button id="uploadBtn" class="btn">ì—…ë¡œë“œ</button>
            </div>
        </div>
    </article>

    <section class="card">
        <h3>ëŒ“ê¸€</h3>
        <div id="commentList"></div>
        <div style="margin-top:10px">
            <textarea id="cmtContent" rows="3" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            <div class="row" style="justify-content:flex-end;margin-top:8px">
                <button id="cmtBtn" class="btn">ë“±ë¡</button>
            </div>
        </div>
    </section>
</main>

<script>
    (function(){
        const q = (s,p=document)=>p.querySelector(s);
        const qp = (k)=>new URLSearchParams(location.search).get(k);
        const api = axios.create({ baseURL: '', withCredentials: true });
        // api.interceptors.request.use(cfg => { const t=localStorage.getItem('accessToken'); if(t) cfg.headers.Authorization=`Bearer ${t}`; return cfg; });

        const readPost = (id)=>api.get(`/api/v1/posts/${id}`).then(r=>r.data);
        const deletePost = (id)=>api.delete(`/api/v1/posts/${id}`);
        const likePost = (id)=>api.post(`/api/v1/posts/${id}/like`);
        const unlikePost = (id)=>api.delete(`/api/v1/posts/${id}/like`);
        const uploadAttachment = (id, file)=>{
            const form = new FormData(); form.append('file', file);
            return api.post(`/api/v1/posts/${id}/attachments`, form, { headers: {'Content-Type':'multipart/form-data'} }).then(r=>r.data);
        };
        const listComments = ({postId,page=0,size=50})=>api.get(`/api/v1/posts/${postId}/comments`,{params:{page,size}}).then(r=>r.data);
        const createComment = ({postId,payload})=>api.post(`/api/v1/posts/${postId}/comments`, payload).then(r=>r.data);

        (async ()=>{
            const id = qp('id');
            if(!id){ alert('post id ëˆ„ë½'); location.href='/community.html'; return; }
            async function loadPost(){
                const p = await readPost(id);
                q('#titleTop').textContent = p.title;
                q('#title').textContent = p.title;
                q('#meta').textContent = `ì‘ì„±ì: ${p.authorName} Â· ${new Date(p.createdAt).toLocaleString()} Â· â¤ï¸ ${p.likeCount} Â· ğŸ‘ï¸ ${p.viewCount}`;
                q('#content').textContent = p.content || '';
                q('#attList').innerHTML = (p.attachments||[]).map(a=>`<a class="chip" href="${a.url}" target="_blank">${a.filename}</a>`).join('');
            }
            async function loadComments(){
                const data = await listComments({postId:id,page:0,size:50});
                q('#commentList').innerHTML = (data.content||[]).map(c=>`
        <div class="row" style="align-items:flex-start; margin:6px 0">
          <div style="flex:1">
            <div style="font-weight:600">${c.authorName} <span style="color:#888;font-size:12px">${new Date(c.createdAt).toLocaleString()}</span></div>
            <div style="white-space:pre-wrap">${c.content}</div>
          </div>
        </div>
      `).join('');
            }
            await loadPost();
            await loadComments();

            q('#likeBtn').onclick = async ()=>{ await likePost(id); await loadPost(); };
            q('#unlikeBtn').onclick = async ()=>{ await unlikePost(id); await loadPost(); };
            q('#delBtn').onclick = async ()=>{
                if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                await deletePost(id); alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤'); history.back();
            };
            q('#uploadBtn').onclick = async ()=>{
                const f = q('#file').files?.[0];
                if(!f) return alert('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”');
                await uploadAttachment(id, f);
                q('#file').value='';
                await loadPost();
            };
            q('#cmtBtn').onclick = async ()=>{
                const content = q('#cmtContent').value.trim();
                if(!content) return;
                await createComment({postId:id, payload:{content}});
                q('#cmtContent').value='';
                await loadComments();
            };
        })();
    })();
</script>
</body>
</html>
